name: Model Training and Deployment

on:
  push:
    branches: [main]
    paths:
      - 'python-api/gritting_prediction_system.py'
      - 'python-api/edinburgh_gritting_training_dataset.csv'
      - 'python-api/routes_database.csv'
      - '.github/workflows/model-deployment.yaml'
  workflow_dispatch:

jobs:
  train-models:
    name: Train ML Models
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'python-api/requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r python-api/requirements.txt

      - name: Train models
        working-directory: python-api
        run: |
          python gritting_prediction_system.py

      - name: Upload models artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: python-api/models/
          retention-days: 1

  deploy-models-to-blob:
    needs: train-models
    name: Deploy Models to Azure Blob Storage
    runs-on: ubuntu-latest
    if: ${{ vars.MODEL_STORAGE_ACCOUNT_NAME != '' && vars.MODEL_STORAGE_CONTAINER_NAME != '' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download models artifact
        uses: actions/download-artifact@v4
        with:
          name: trained-models
          path: models/

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Upload models to Azure Blob Storage
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ vars.MODEL_STORAGE_ACCOUNT_NAME }} \
              --destination ${{ vars.MODEL_STORAGE_CONTAINER_NAME }} \
              --source models/ \
              --overwrite \
              --auth-mode login
