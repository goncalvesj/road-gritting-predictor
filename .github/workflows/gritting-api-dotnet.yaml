name: Gritting API (.NET) - Build, Push, and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'Gritting.Api/**'
      - '.github/workflows/gritting-api-dotnet.yaml'
  workflow_dispatch:

jobs:
  dotnet-build:
    name: .NET build Gritting API
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Gritting API
        uses: yxtc4/devops/.github/actions/build-dotnet@main
        with:
          working-directory: 'Gritting.Api'
          configuration: 'Release'
          dotnet-version: '9.0.x'

  push-gritting-api-to-acr:
    needs: dotnet-build
    uses: yxtc4/devops/.github/workflows/reusable-docker-push-to-acr.yml@main
    name: Push Gritting API
    with:
      image-name: gritting-api
      dockerfile-location: Gritting.Api/Dockerfile
      build-context: .
    secrets: inherit
    permissions:
      contents: read
      id-token: write

  deploy-gritting-api-to-aca:
    needs: push-gritting-api-to-acr
    uses: yxtc4/devops/.github/workflows/reusable-deploy-to-aca.yml@main
    name: Deploy Gritting API to ACA
    if: ${{ vars.GRITTING_API_RESOURCE_GROUP != '' && vars.GRITTING_API_ACA_NAME != '' }}
    with:
      resource-group: ${{ vars.GRITTING_API_RESOURCE_GROUP }}
      aca-name: ${{ vars.GRITTING_API_ACA_NAME }}
      image-uri: ${{ needs.push-gritting-api-to-acr.outputs.image-uri }}
      image-digest: ${{ needs.push-gritting-api-to-acr.outputs.image-digest }}
    secrets: inherit
    permissions:
      contents: read
      id-token: write
